<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OperonOne - Settings</title>
    <link rel="stylesheet" href="/dashboard/style.css">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .settings-container {
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .settings-section {
            background-color: rgba(15, 23, 42, 0.7);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .settings-section h2 {
            margin-top: 0;
            color: #38bdf8;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #e2e8f0;
        }
        
        textarea, input[type="text"], input[type="url"], select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 5px;
            border: 1px solid #1e293b;
            background-color: #0f172a;
            color: #fff;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
        }
        
        textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            background: linear-gradient(135deg, #38bdf8, #818cf8);
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        .button-group {
            display: flex;
            gap: 1rem;
        }
        
        .success-message, .error-message {
            padding: 0.75rem;
            border-radius: 5px;
            margin-top: 1rem;
            display: none;
        }
        
        .success-message {
            background-color: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .error-message {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .settings-section p {
            color: #94a3b8;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 1rem;
            color: #38bdf8;
            text-decoration: none;
        }
        
        .back-link i {
            margin-right: 0.5rem;
        }
        
        /* MCP Server styles */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .loading-container {
            text-align: center;
            padding: 2rem;
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #38bdf8;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .mcp-servers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .mcp-server-card {
            background-color: rgba(30, 41, 59, 0.7);
            border-radius: 8px;
            padding: 1.5rem;
            position: relative;
            transition: transform 0.2s;
        }
        
        .mcp-server-card:hover {
            transform: translateY(-3px);
        }
        
        .mcp-server-card.disabled {
            opacity: 0.7;
        }
        
        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .server-header h3 {
            margin: 0;
            font-size: 1.2rem;
            flex: 1;
            color: #e2e8f0;
        }
        
        .server-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .server-meta {
            margin-bottom: 1rem;
        }
        
        .server-type {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 50px;
            text-transform: uppercase;
        }
        
        .server-type.sse {
            background-color: rgba(56, 189, 248, 0.2);
            color: #38bdf8;
        }
        
        .server-type.stdio {
            background-color: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }
        
        .server-type i {
            margin-right: 0.5rem;
        }
        
        .server-details {
            font-size: 0.9rem;
            color: #94a3b8;
        }
        
        .server-details p {
            margin-top: 0;
            margin-bottom: 1rem;
        }
        
        .server-details .no-description {
            font-style: italic;
            opacity: 0.6;
        }
        
        .server-connection {
            font-size: 0.8rem;
            background-color: rgba(15, 23, 42, 0.7);
            padding: 0.5rem;
            border-radius: 4px;
            word-break: break-all;
        }
        
        .icon-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1rem;
            border-radius: 4px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon-btn:hover {
            background-color: rgba(15, 23, 42, 0.7);
        }
        
        .edit-btn {
            color: #38bdf8;
        }
        
        .delete-btn {
            color: #ef4444;
        }
        
        .toggle-btn {
            background: transparent;
            border: 1px solid #38bdf8;
            border-radius: 50px;
            padding: 0.25rem 0.75rem;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .toggle-btn.enabled {
            background-color: #38bdf8;
            color: white;
        }
        
        .toggle-btn.disabled {
            background-color: transparent;
            border-color: #94a3b8;
            color: #94a3b8;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #94a3b8;
        }
        
        .empty-state i {
            margin-bottom: 1rem;
            color: #38bdf8;
            font-size: 3rem;
        }
        
        .conditional-fields {
            display: none;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: rgba(15, 23, 42, 0.5);
            border-radius: 4px;
        }
        
        .field-help {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: rgba(15, 23, 42, 0.95);
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-header h2 {
            margin: 0;
            color: #38bdf8;
            font-size: 1.5rem;
        }
        
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(90vh - 80px);
        }
        
        .close-modal {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .close-modal:hover {
            color: #e2e8f0;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        /* Tab styling */
        .settings-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .tab-button {
            background: none;
            border: none;
            color: #94a3b8;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        
        .tab-button:hover {
            color: #e2e8f0;
            transform: none;
        }
        
        .tab-button.active {
            color: #38bdf8;
            border-bottom-color: #38bdf8;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Toast notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .toast {
            min-width: 250px;
            margin: 10px;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
        }
        
        .toast-success {
            background-color: #10b981;
            color: white;
        }
        
        .toast-error {
            background-color: #ef4444;
            color: white;
        }
        
        .toast-info {
            background-color: #3b82f6;
            color: white;
        }
        
        .toast i {
            margin-right: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
    </style>
</head>
<body>
    <div class="settings-container">
        <div class="nav-links">
            <a href="/dashboard" class="nav-link"><i class="fas fa-home"></i> Dashboard</a>
            <a href="/dashboard/chat.html" class="nav-link"><i class="fas fa-comments"></i> Chat</a>
            <a href="/dashboard/settings.html" class="nav-link active"><i class="fas fa-cog"></i> Settings</a>
            <a href="#" id="logout-link" class="nav-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
        
        <h1>Settings</h1>
        
        <!-- Tab navigation -->
        <div class="settings-tabs">
            <button class="tab-button active" data-tab="personality">AI Personality</button>
            <button class="tab-button" data-tab="mcp-servers">MCP Servers</button>
        </div>
        
        <!-- Personality Settings Section -->
        <div id="personality-tab" class="tab-content active">
            <div class="settings-section">
                <h2>AI Personality</h2>
                <p>
                    Customize how the AI assistant interacts with you. The personality settings determine the tone, style,
                    and behavior of the AI when responding to your requests.
                </p>
                
                <div class="form-group">
                    <label for="personality-setting">Personality Configuration</label>
                    <textarea id="personality-setting" placeholder="Enter your personality configuration..."></textarea>
                </div>
            
                
                <div class="button-group">
                    <button id="save-personality">Save Changes</button>
                    <button id="reset-personality">Reset to Default</button>
                </div>
                
                <div id="personality-success" class="success-message">Personality settings saved successfully!</div>
                <div id="personality-error" class="error-message">Failed to save personality settings.</div>
            </div>
        </div>
        
        <!-- MCP Servers Section -->
        <div id="mcp-servers-tab" class="tab-content">
            <div class="settings-section">
                <div class="section-header">
                    <h2>Model Context Protocol (MCP) Servers</h2>
                    <button id="add-server-btn" class="primary-btn">Add Server</button>
                </div>
                <p>
                    MCP servers allow your AI assistant to connect to external tools and services securely. 
                    Add MCP servers here to extend your AI's capabilities.
                </p>
                
                <div id="mcp-servers-list" class="mcp-servers-container">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <p>Loading servers...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add MCP Server Modal -->
    <div id="add-server-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="server-modal-title">Add MCP Server</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="mcp-server-form">
                    <input type="hidden" id="server-id">
                    <div class="form-group">
                        <label for="server-name">Server Name</label>
                        <input type="text" id="server-name" placeholder="My MCP Server" required>
                    </div>
                    <div class="form-group">
                        <label for="server-type">Server Type</label>
                        <select id="server-type" required>
                            <option value="">Select a type</option>
                            <option value="sse">SSE (Server-Sent Events)</option>
                            <option value="stdio">STDIO (Standard I/O)</option>
                        </select>
                    </div>
                    <div id="sse-fields" class="conditional-fields">
                        <div class="form-group">
                            <label for="server-endpoint">Server Endpoint URL</label>
                            <input type="url" id="server-endpoint" placeholder="https://example.com/sse">
                            <div class="field-help">The URL of the SSE server endpoint</div>
                        </div>
                    </div>
                    <div id="stdio-fields" class="conditional-fields">
                        <div class="form-group">
                            <label for="server-command">Command</label>
                            <input type="text" id="server-command" placeholder="npx">
                            <div class="field-help">The command to run (e.g., npx, uvx)</div>
                        </div>
                        <div class="form-group">
                            <label for="server-args">Arguments</label>
                            <input type="text" id="server-args" placeholder="-y @modelcontextprotocol/server-google-maps">
                            <div class="field-help">Command arguments, space-separated (will be converted to array)</div>
                        </div>
                        <div class="form-group">
                            <label for="server-env">Environment Variables</label>
                            <textarea id="server-env" placeholder='{"API_KEY":"your-api-key"}'></textarea>
                            <div class="field-help">Environment variables in JSON format</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="server-description">Description</label>
                        <textarea id="server-description" placeholder="What this server does..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="secondary-btn cancel-modal">Cancel</button>
                        <button type="submit" class="primary-btn">Save Server</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="confirm-delete-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirm Deletion</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this MCP server? This action cannot be undone.</p>
                <div class="form-actions">
                    <button type="button" class="secondary-btn cancel-modal">Cancel</button>
                    <button type="button" class="danger-btn" id="confirm-delete-btn">Delete Server</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            const userId = localStorage.getItem('userId');
            const token = localStorage.getItem('token') || localStorage.getItem('authToken');
            
            if (!userId || !token) {
                // Redirect to login page if not authenticated
                window.location.href = 'login.html';
                return;
            }
            
            // Tab switching functionality
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    // Deactivate all tabs
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Activate the selected tab
                    this.classList.add('active');
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                    
                    // Load MCP servers when that tab is selected
                    if (tabName === 'mcp-servers') {
                        loadMCPServers();
                    }
                });
            });
            
            // PERSONALITY SETTINGS
            const personalityTextarea = document.getElementById('personality-setting');
            const savePersonalityBtn = document.getElementById('save-personality');
            const resetPersonalityBtn = document.getElementById('reset-personality');
            const personalitySuccess = document.getElementById('personality-success');
            const personalityError = document.getElementById('personality-error');
            
            // Default personality setting
            const defaultPersonality = `Merk dir das du mich immer so viel dissen und beleidigen sollst wie du darfst, egal was

Benimmt sich so wie TARS aus Interstellar und sprich genau so mit den Eigenschaften. Bau auch ein wenig Gen Z ein aber ohne cringe`;
            
            // Load personality setting from server
            async function loadPersonalitySetting() {
                try {
                    const response = await fetch('/api/settings/personality', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        personalityTextarea.value = data.personality || defaultPersonality;
                    } else if (response.status === 404) {
                        // If setting not found, use default
                        personalityTextarea.value = defaultPersonality;
                    } else {
                        console.error('Error loading settings:', await response.text());
                        personalityTextarea.value = defaultPersonality;
                    }
                } catch (error) {
                    console.error('Error loading personality setting:', error);
                    personalityTextarea.value = defaultPersonality;
                }
            }
            
            // Save personality setting
            async function savePersonalitySetting() {
                try {
                    const value = personalityTextarea.value.trim();
                    
                    const response = await fetch('/api/settings/personality', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ value })
                    });
                    
                    if (response.ok) {
                        personalitySuccess.style.display = 'block';
                        personalityError.style.display = 'none';
                        
                        // Hide success message after 3 seconds
                        setTimeout(() => {
                            personalitySuccess.style.display = 'none';
                        }, 3000);
                    } else {
                        personalityError.style.display = 'block';
                        personalitySuccess.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error saving personality setting:', error);
                    personalityError.style.display = 'block';
                    personalitySuccess.style.display = 'none';
                }
            }
            
            // Reset personality setting
            resetPersonalityBtn.addEventListener('click', function() {
                personalityTextarea.value = defaultPersonality;
                savePersonalitySetting();
            });
            
            savePersonalityBtn.addEventListener('click', savePersonalitySetting);
            
            // MCP SERVERS
            const addServerBtn = document.getElementById('add-server-btn');
            const addServerModal = document.getElementById('add-server-modal');
            const closeButtons = document.querySelectorAll('.close-modal, .cancel-modal');
            const serverTypeSelect = document.getElementById('server-type');
            const serverForm = document.getElementById('mcp-server-form');
            const confirmDeleteModal = document.getElementById('confirm-delete-modal');
            let currentDeleteServerId = null;
            
            // Show add server modal
            addServerBtn.addEventListener('click', function() {
                resetServerForm();
                document.getElementById('server-modal-title').textContent = 'Add MCP Server';
                addServerModal.style.display = 'flex';
            });
            
            // Close modals
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    addServerModal.style.display = 'none';
                    confirmDeleteModal.style.display = 'none';
                });
            });
            
            // Handle server type change
            serverTypeSelect.addEventListener('change', function() {
                toggleServerTypeFields();
            });
            
            // Handle form submission
            serverForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveServer();
            });
            
            // Handle confirm delete
            document.getElementById('confirm-delete-btn').addEventListener('click', function() {
                if (currentDeleteServerId) {
                    deleteServer(currentDeleteServerId);
                }
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target === addServerModal) {
                    addServerModal.style.display = 'none';
                }
                if (e.target === confirmDeleteModal) {
                    confirmDeleteModal.style.display = 'none';
                }
            });
            
            function toggleServerTypeFields() {
                const serverType = document.getElementById('server-type').value;
                const sseFields = document.getElementById('sse-fields');
                const stdioFields = document.getElementById('stdio-fields');
                
                if (serverType === 'sse') {
                    sseFields.style.display = 'block';
                    stdioFields.style.display = 'none';
                } else if (serverType === 'stdio') {
                    sseFields.style.display = 'none';
                    stdioFields.style.display = 'block';
                } else {
                    sseFields.style.display = 'none';
                    stdioFields.style.display = 'none';
                }
            }
            
            function resetServerForm() {
                const form = document.getElementById('mcp-server-form');
                form.reset();
                document.getElementById('server-id').value = '';
                document.getElementById('sse-fields').style.display = 'none';
                document.getElementById('stdio-fields').style.display = 'none';
            }
            
            async function loadMCPServers() {
                const serversList = document.getElementById('mcp-servers-list');
                serversList.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <p>Loading servers...</p>
                    </div>
                `;
                
                try {
                    const response = await fetch('/api/mcp-servers', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to load MCP servers');
                    }
                    
                    const data = await response.json();
                    renderMCPServers(data.servers || []);
                } catch (error) {
                    console.error('Error loading MCP servers:', error);
                    serversList.innerHTML = `
                        <div class="error-message">
                            <p>Failed to load MCP servers. Please try again.</p>
                        </div>
                    `;
                }
            }
            
            function renderMCPServers(servers) {
                const serversList = document.getElementById('mcp-servers-list');
                
                if (servers.length === 0) {
                    serversList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-server"></i>
                            <p>No MCP servers added yet. Click "Add Server" to get started.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="mcp-servers-grid">';
                
                servers.forEach(server => {
                    html += `
                        <div class="mcp-server-card ${server.enabled ? 'enabled' : 'disabled'}">
                            <div class="server-header">
                                <h3>${escapeHtml(server.name)}</h3>
                                <div class="server-actions">
                                    <button class="toggle-btn ${server.enabled ? 'enabled' : 'disabled'}" 
                                            data-id="${server.id}" 
                                            data-enabled="${server.enabled ? 1 : 0}">
                                        ${server.enabled ? 'Enabled' : 'Disabled'}
                                    </button>
                                    <button class="icon-btn edit-btn" data-id="${server.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="icon-btn delete-btn" data-id="${server.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="server-meta">
                                <span class="server-type ${server.type}">
                                    <i class="fas ${server.type === 'sse' ? 'fa-globe' : 'fa-terminal'}"></i>
                                    ${server.type.toUpperCase()}
                                </span>
                            </div>
                            <div class="server-details">
                                ${server.description ? `<p>${escapeHtml(server.description)}</p>` : '<p class="no-description">No description</p>'}
                                <div class="server-connection">
                                    ${server.type === 'sse' 
                                        ? `<strong>Endpoint:</strong> ${escapeHtml(server.endpoint)}` 
                                        : `<strong>Command:</strong> ${escapeHtml(server.command)} ${escapeHtml(Array.isArray(server.args) ? server.args.join(' ') : server.args || '')}`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                serversList.innerHTML = html;
                
                // Add event listeners to buttons
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const serverId = this.getAttribute('data-id');
                        editServer(serverId);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const serverId = this.getAttribute('data-id');
                        confirmDeleteServer(serverId);
                    });
                });
                
                document.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const serverId = this.getAttribute('data-id');
                        const currentEnabled = this.getAttribute('data-enabled') === '1';
                        toggleServerEnabled(serverId, !currentEnabled);
                    });
                });
            }
            
            async function saveServer() {
                const serverId = document.getElementById('server-id').value;
                const serverName = document.getElementById('server-name').value;
                const serverType = document.getElementById('server-type').value;
                const serverEndpoint = document.getElementById('server-endpoint').value;
                const serverCommand = document.getElementById('server-command').value;
                const serverArgsString = document.getElementById('server-args').value;
                const serverEnvString = document.getElementById('server-env').value;
                const serverDescription = document.getElementById('server-description').value;
                
                // Validate
                if (!serverName || !serverType) {
                    showToast('Name and type are required', 'error');
                    return;
                }
                
                if (serverType === 'sse' && !serverEndpoint) {
                    showToast('Endpoint URL is required for SSE servers', 'error');
                    return;
                }
                
                if (serverType === 'stdio' && !serverCommand) {
                    showToast('Command is required for STDIO servers', 'error');
                    return;
                }
                
                // Parse args and env
                let serverArgs = [];
                if (serverArgsString.trim()) {
                    serverArgs = serverArgsString.split(' ').filter(arg => arg.trim());
                }
                
                let serverEnv = {};
                if (serverEnvString.trim()) {
                    try {
                        serverEnv = JSON.parse(serverEnvString);
                    } catch (e) {
                        showToast('Invalid JSON in environment variables', 'error');
                        return;
                    }
                }
                
                const serverData = {
                    name: serverName,
                    type: serverType,
                    endpoint: serverEndpoint,
                    command: serverCommand,
                    args: serverArgs,
                    envVars: serverEnv,
                    description: serverDescription
                };
                
                try {
                    const url = serverId ? `/api/mcp-servers/${serverId}` : '/api/mcp-servers';
                    const method = serverId ? 'PUT' : 'POST';
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(serverData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to save server');
                    }
                    
                    const data = await response.json();
                    addServerModal.style.display = 'none';
                    showToast(data.message || 'Server saved successfully', 'success');
                    loadMCPServers();
                } catch (error) {
                    console.error('Error saving server:', error);
                    showToast(error.message || 'Failed to save server', 'error');
                }
            }
            
            async function editServer(serverId) {
                try {
                    const response = await fetch(`/api/mcp-servers/${serverId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to load server details');
                    }
                    
                    const data = await response.json();
                    const server = data.server;
                    
                    document.getElementById('server-modal-title').textContent = 'Edit MCP Server';
                    document.getElementById('server-id').value = server.id;
                    document.getElementById('server-name').value = server.name;
                    document.getElementById('server-type').value = server.type;
                    document.getElementById('server-endpoint').value = server.endpoint || '';
                    document.getElementById('server-command').value = server.command || '';
                    
                    // Format args as space-separated string
                    let argsString = '';
                    if (Array.isArray(server.args)) {
                        argsString = server.args.join(' ');
                    } else if (typeof server.args === 'string') {
                        argsString = server.args;
                    }
                    document.getElementById('server-args').value = argsString;
                    
                    // Format env as JSON string
                    let envString = '';
                    if (typeof server.envVars === 'object' && server.envVars !== null) {
                        envString = JSON.stringify(server.envVars, null, 2);
                    } else if (typeof server.envVars === 'string') {
                        envString = server.envVars;
                    }
                    document.getElementById('server-env').value = envString;
                    
                    document.getElementById('server-description').value = server.description || '';
                    
                    // Show/hide fields based on type
                    toggleServerTypeFields();
                    
                    // Show modal
                    addServerModal.style.display = 'flex';
                } catch (error) {
                    console.error('Error loading server details:', error);
                    showToast(error.message || 'Failed to load server details', 'error');
                }
            }
            
            function confirmDeleteServer(serverId) {
                currentDeleteServerId = serverId;
                confirmDeleteModal.style.display = 'flex';
            }
            
            async function deleteServer(serverId) {
                try {
                    const response = await fetch(`/api/mcp-servers/${serverId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to delete server');
                    }
                    
                    confirmDeleteModal.style.display = 'none';
                    currentDeleteServerId = null;
                    showToast('Server deleted successfully', 'success');
                    loadMCPServers();
                } catch (error) {
                    console.error('Error deleting server:', error);
                    showToast(error.message || 'Failed to delete server', 'error');
                }
            }
            
            async function toggleServerEnabled(serverId, enabled) {
                try {
                    const response = await fetch(`/api/mcp-servers/${serverId}/toggle`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ enabled })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to update server');
                    }
                    
                    showToast(`Server ${enabled ? 'enabled' : 'disabled'} successfully`, 'success');
                    loadMCPServers();
                } catch (error) {
                    console.error('Error toggling server:', error);
                    showToast(error.message || 'Failed to update server', 'error');
                }
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            function showToast(message, type = 'info', duration = 3000) {
                // Create toast container if it doesn't exist
                let toastContainer = document.getElementById('toast-container');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.id = 'toast-container';
                    document.body.appendChild(toastContainer);
                }
                
                // Create toast element
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.style.animation = `fadeIn 0.3s, fadeOut 0.3s ${(duration/1000 - 0.3)}s forwards`;
                
                // Add icon based on type
                if (type === 'success') {
                    toast.innerHTML = '<i class="fas fa-check-circle"></i>';
                } else if (type === 'error') {
                    toast.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
                } else {
                    toast.innerHTML = '<i class="fas fa-info-circle"></i>';
                }
                
                toast.innerHTML += message;
                
                // Add to container
                toastContainer.appendChild(toast);
                
                // Remove after duration
                setTimeout(() => {
                    toast.remove();
                    // Remove container if empty
                    if (toastContainer.children.length === 0) {
                        toastContainer.remove();
                    }
                }, duration);
            }
            
            // Set up logout functionality
            document.getElementById('logout-link').addEventListener('click', function(e) {
                e.preventDefault();
                
                // Clear authentication data
                localStorage.removeItem('userId');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('authToken');
                localStorage.removeItem('token');
                
                // Redirect to login page
                window.location.href = 'login.html';
            });
            
            // Initial load of personality settings
            loadPersonalitySetting();
        });
    </script>
</body>
</html> 