<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/assets/logo.png">
    <link rel="apple-touch-icon" href="/assets/logo.png">
    <title>Operon.one Dashboard</title>
    <link rel="stylesheet" href="/dashboard/style.css">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .welcome-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 2rem;
            text-align: center;
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            animation: fadeInUp 1s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes float {
            0%, 100% {
                transform: translate(-50%, -50%) translateY(0px);
            }
            50% {
                transform: translate(-50%, -50%) translateY(-10px);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        
        .welcome-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120%;
            height: 120%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.08) 0%, transparent 70%);
            border-radius: 50%;
            z-index: -1;
            animation: float 4s ease-in-out infinite;
        }
        
        .welcome-container::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(236, 72, 153, 0.03) 0%, transparent 80%);
            border-radius: 50%;
            z-index: -1;
            animation: float 6s ease-in-out infinite reverse;
        }
        
        .welcome-container h1 {
            font-size: clamp(2rem, 5vw, 3.5rem);
            margin-bottom: 2.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            letter-spacing: -0.02em;
            line-height: 1.1;
            animation: shimmer 3s ease-in-out infinite, pulse 2s ease-in-out infinite;
        }
        
        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(99, 102, 241, 0.1);
            }
            50% {
                box-shadow: 0 0 30px rgba(99, 102, 241, 0.2), 0 0 40px rgba(236, 72, 153, 0.1);
            }
        }
        
        .welcome-input-container {
            width: 100%;
            max-width: 650px;
            margin-bottom: 1rem;
            position: relative;
            animation: slideInFromBottom 1s ease-out 0.3s both;
        }
        
        .welcome-input {
            width: 100%;
            padding: 18px 70px 18px 24px;
            border-radius: var(--border-radius-xl);
            border: 2px solid rgba(71, 85, 105, 0.3);
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: var(--light);
            font-size: 1.1rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow);
            font-weight: 400;
            position: relative;
            z-index: 1;
            resize: vertical;
            font-family: var(--font-main);
            line-height: 1.5;
            min-height: 80px;
            max-height: 300px;
        }
        
        .welcome-input::placeholder {
            color: var(--gray);
            font-weight: 400;
            transition: all 0.3s ease;
        }
        
        .welcome-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2), 
                        0 0 20px rgba(99, 102, 241, 0.1),
                        var(--shadow-lg);
            background: rgba(30, 41, 59, 0.8);
            transform: translateY(-2px);
            animation: glow 2s ease-in-out infinite;
        }
        
        .welcome-input:hover:not(:focus) {
            border-color: rgba(99, 102, 241, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.05), var(--shadow-lg);
        }
        
        .welcome-send-button {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            border-radius: var(--border-radius-lg);
            color: white;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            z-index: 2;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .welcome-send-button:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        .welcome-send-button:active {
            transform: translateY(-50%) scale(0.95);
            transition-duration: 0.1s;
        }
        
        .welcome-send-button i {
            transition: transform 0.3s ease;
        }
        
        .welcome-send-button:hover i {
            transform: translateX(2px);
        }
        


        .chat-interface {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .chat-interface.active {
            display: flex;
        }

        .welcome-screen {
            display: flex;
            height: 100%;
            background: transparent;
        }

        .welcome-screen.hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .welcome-container {
                padding: 1.5rem;
            }
            
            .welcome-container h1 {
                margin-bottom: 2rem;
            }
            
            .welcome-input {
                padding: 16px 60px 16px 20px;
                font-size: 1rem;
            }
            
            .welcome-send-button {
                width: 42px;
                height: 42px;
                right: 6px;
                font-size: 0.9rem;
            }
            
            .welcome-container::before {
                width: 150%;
                height: 150%;
            }
            
            .welcome-container::after {
                width: 120%;
                height: 120%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo-text">Operon.one</div>
                <button id="new-task-button"><i class="fas fa-plus"></i> New Task</button>
            </div>
            <!-- Placeholder for dynamically loaded recent chats -->
            <div class="recent-chats-container" id="recent-chats-list">
                <p style="padding: 15px; color: var(--gray);">Loading chats...</p>
            </div>
            <div class="sidebar-footer">
                <!-- User Info -->
                <div class="user-profile-section">
                     <div class="user-details">
                         <span id="user-info">User: Loading...</span>
                         <!-- Credits Section -->
                         <div class="credits-display">
                             <div class="credits-info">
                                 <i class="fas fa-coins"></i>
                                 <span id="credits-count">0</span> credits
                             </div>
                             <button class="redeem-button" onclick="showRedeemModal()" title="Redeem Code">
                                 <i class="fas fa-plus"></i>
                             </button>
                         </div>
                     </div>
                     <div class="user-actions">
                         <!-- Settings Button/Link -->
                         <a href="/settings" id="settings-link" title="Settings"><i class="fas fa-cog"></i></a>
                         <!-- Logout Button -->
                         <button id="logout-button" class="icon-button" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
                     </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <div class="chat-container">
            <!-- Welcome Screen -->
            <div class="welcome-screen" id="welcome-screen">
                <div class="welcome-container">
                    <h1>Welcome to Operon.one</h1>
                    
                    <div class="welcome-input-container">
                        <textarea class="welcome-input" id="welcome-input" placeholder="What would you like to accomplish today?&#10;&#10;Press Ctrl+Enter to submit" rows="3"></textarea>
                        <button class="welcome-send-button" id="start-button">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Interface -->
            <div class="chat-interface" id="chat-interface">
                <!-- Status Display Area -->
                <div id="status-display" class="status-display">
                    <div class="status-content">
                        <i class="fas fa-info-circle"></i> Ready to help with complex tasks
                    </div>
                    <div class="status-actions">
                        <button class="upload-toggle-btn" id="upload-toggle-btn" title="Upload Files">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </button>
                        <button class="tools-toggle-btn" id="tools-toggle-btn" title="Show Tools">
                            <i class="fas fa-tools"></i>
                        </button>
                    </div>
                </div>
                <div class="chat-messages" id="chat-messages">
                    <!-- Chat messages will be appended here -->
                </div>
                <div class="chat-input">
                    <button class="chat-upload-button" id="chat-upload-button" title="Upload Files">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <textarea id="message-input" placeholder="Enter your task or question...&#10;Press Ctrl+Enter to submit" rows="2"></textarea>
                    <button id="send-button">Send</button>
                    <input type="file" id="chat-file-input" multiple accept="*/*" style="display: none;">
                </div>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="file-upload-section" id="file-upload-section" style="display: none;">
            <h3><i class="fas fa-cloud-upload-alt"></i> Upload Files</h3>
            
            <div class="file-upload-container">
                <div class="file-upload-dropzone" id="file-dropzone">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">Drop files here or click to upload</div>
                    <div class="upload-hint">Supports all file types â€¢ Max 50MB per file</div>
                    <button class="file-upload-button" id="upload-button">
                        <i class="fas fa-plus"></i>
                        Choose Files
                    </button>
                    <input type="file" class="file-upload-input" id="file-input" multiple accept="*/*">
                </div>
                
                <div class="upload-progress" id="upload-progress">
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                    <div class="progress-text" id="progress-text">Ready to upload</div>
                </div>
                
                <div class="upload-results" id="upload-results">
                    <div id="upload-message"></div>
                </div>
            </div>
        </div>

        <!-- Uploaded Files Management Section -->
        <div class="uploaded-files-section" id="uploaded-files-section" style="display: none;">
            <h3><i class="fas fa-folder-open"></i> Uploaded Files</h3>
            <div class="uploaded-files-list" id="uploaded-files-list">
                <div class="uploaded-files-list empty">
                    <i class="fas fa-folder-open"></i>
                    <p>Loading files...</p>
                </div>
            </div>
        </div>

        <!-- Tool Sidebar -->
        <aside class="tool-sidebar" id="tool-sidebar">
            <div class="tool-sidebar-header">
                <h3>Tools</h3>
                <button class="tool-sidebar-toggle" id="tool-sidebar-toggle">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="tool-sidebar-content" id="tool-sidebar-content">
                <div class="tool-sidebar-empty">
                    <i class="fas fa-tools"></i>
                    <p>No active tools</p>
                </div>
            </div>
        </aside>
    </div>

    <!-- Redeem Code Modal -->
    <div id="redeem-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Redeem Credits Code</h3>
                <button class="modal-close" onclick="hideRedeemModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="redeem-form">
                    <input type="text" id="redeem-code-input" placeholder="Enter your code" maxlength="20">
                    <button id="redeem-submit-btn" onclick="redeemCode()">Redeem</button>
                </div>
                <div id="redeem-message" class="redeem-message"></div>
            </div>
        </div>
    </div>

    <script src="/dashboard/script.js"></script>
    <!-- Socket.IO Client Library -->
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <!-- Marked.js for Markdown Rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const userId = localStorage.getItem('userId');
            const userEmail = localStorage.getItem('userEmail');
            const authToken = localStorage.getItem('authToken');
            
            if (!userId || !authToken) {
                window.location.href = '/login';
                return;
            }
            
            // Validate token with server on page load
            try {
                const tokenValidation = await fetch('/api/validate-token', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!tokenValidation.ok) {
                    throw new Error('Token validation failed');
                }
                
                const validationData = await tokenValidation.json();
                if (!validationData.valid) {
                    throw new Error('Invalid token');
                }
            } catch (error) {
                console.error('Token validation error:', error);
                localStorage.removeItem('userId');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('authToken');
                localStorage.removeItem('currentChatId');
                localStorage.removeItem('initialQuery');
                window.location.href = '/login';
                return;
            }
            
            document.getElementById('user-info').textContent = `User: ${userEmail || 'Authenticated'}`;
            
            // Load user credits
            loadUserCredits();
            
            document.getElementById('logout-button').addEventListener('click', async function() {
                try {
                    // Call logout API to clear server-side session
                    await fetch('/api/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                } catch (error) {
                    console.error('Logout API error:', error);
                }
                
                // Clear client-side storage
                localStorage.removeItem('userId');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('authToken');
                localStorage.removeItem('currentChatId');
                localStorage.removeItem('initialQuery');
                
                // Redirect to login
                window.location.href = '/login';
            });

            // Check if we should show chat interface immediately
            const currentChatId = localStorage.getItem('currentChatId');
            const initialQuery = localStorage.getItem('initialQuery');
            
            if (currentChatId && currentChatId !== 'new' && !initialQuery) {
                // Show chat interface if we have an existing chat
                showChatInterface();
            } else if (initialQuery) {
                // Show chat interface and start with initial query
                showChatInterface();
            } else {
                // Always show welcome screen for new task creation
                showWelcomeScreen();
                loadWelcomePageChats();
                // Auto-focus the input for immediate task creation
                setTimeout(() => {
                    document.getElementById('welcome-input').focus();
                }, 100);
            }
            
            function showWelcomeScreen() {
                document.getElementById('welcome-screen').classList.remove('hidden');
                document.getElementById('chat-interface').classList.remove('active');
            }
            
            function showChatInterface() {
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('chat-interface').classList.add('active');
                
                // Check if we need to handle an initial query
                if (window.handleInitialQuery) {
                    window.handleInitialQuery();
                }
            }
            
            // Make showChatInterface globally available
            window.showChatInterface = showChatInterface;
            window.showWelcomeScreen = showWelcomeScreen;
            
            function loadUserCredits() {
                fetch('/api/credits', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                })
                .then(data => {
                    if (data && data.credits !== undefined) {
                        const creditsElement = document.getElementById('credits-count');
                        if (creditsElement) {
                            creditsElement.textContent = data.credits.toLocaleString();
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading credits:', error);
                });
            }
            
            function loadWelcomePageChats() {
                fetch('/api/chats', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load chats');
                    }
                    return response.json();
                })
                .then(data => {
                    const recentChatsList = document.getElementById('recent-chats-list');
                    recentChatsList.innerHTML = '';
                    
                    if (!data.chats || data.chats.length === 0) {
                        recentChatsList.innerHTML = '<p style="padding: 15px; color: var(--gray);">No chats found</p>';
                        return;
                    }
                    
                    data.chats.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                    
                    data.chats.forEach(chat => {
                        const chatItem = document.createElement('div');
                        chatItem.className = 'recent-chat-item';
                        chatItem.dataset.chatId = chat.id;
                        
                        const chatDate = new Date(chat.updatedAt);
                        const today = new Date();
                        let timeDisplay;
                        
                        if (chatDate.toDateString() === today.toDateString()) {
                            timeDisplay = 'Today';
                        } else if (chatDate.toDateString() === new Date(today - 86400000).toDateString()) {
                            timeDisplay = 'Yesterday';
                        } else {
                            timeDisplay = chatDate.toLocaleDateString();
                        }
                        
                        chatItem.innerHTML = `
                            <div class="chat-content">
                                <span class="chat-title">${chat.title}</span>
                                <span class="chat-timestamp">${timeDisplay}</span>
                            </div>
                            <button class="delete-chat-btn" title="Delete chat" data-chat-id="${chat.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                        
                        chatItem.querySelector('.chat-content').addEventListener('click', () => {
                            // Reset any loading flags when switching chats
                            window.isLoadingHistory = false;
                            
                            localStorage.setItem('currentChatId', chat.id);
                            
                            // Auto-close file upload sidebar when switching chats
                            if (window.closeFileUploadSidebar) {
                                window.closeFileUploadSidebar();
                            }
                            
                            showChatInterface();
                            // Trigger the script.js chat loading by dispatching a custom event
                            window.dispatchEvent(new CustomEvent('loadChat', { detail: { chatId: chat.id } }));
                        });
                        
                        chatItem.querySelector('.delete-chat-btn').addEventListener('click', async (e) => {
                            e.stopPropagation();
                            if (!confirm('Are you sure you want to delete this chat?')) {
                                return;
                            }
                            
                            try {
                                const response = await fetch(`/api/chats/${chat.id}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${authToken}`
                                    }
                                });
                                
                                if (!response.ok) {
                                    throw new Error('Failed to delete chat');
                                }
                                
                                loadWelcomePageChats();
                                
                            } catch (error) {
                                console.error('Error deleting chat:', error);
                                alert('Failed to delete chat: ' + error.message);
                            }
                        });
                        
                        recentChatsList.appendChild(chatItem);
                    });
                })
                .catch(error => {
                    console.error('Error loading chats:', error);
                    document.getElementById('recent-chats-list').innerHTML = 
                        '<p style="padding: 15px; color: var(--gray);">Failed to load chats</p>';
                });
            }
            
            document.getElementById('start-button').addEventListener('click', function() {
                const input = document.getElementById('welcome-input').value.trim();
                if (input) {
                    document.getElementById('start-button').disabled = true;
                    document.getElementById('start-button').textContent = 'Starting...';
                    
                    // Check if we already have a valid chat from file uploads
                    const currentChatId = localStorage.getItem('currentChatId');
                    const hasValidChat = currentChatId && currentChatId !== 'new' && !isNaN(parseInt(currentChatId, 10));
                    
                    console.log('Start button - checking chat ID:', { currentChatId, hasValidChat });
                    
                    if (!hasValidChat) {
                        // No valid chat from uploads, will create new one during message send
                        localStorage.setItem('currentChatId', 'new');
                        console.log('No valid chat from uploads, setting to new');
                    } else {
                        console.log('Keeping existing chat from file uploads:', currentChatId);
                        // Keep the existing valid chat ID from file uploads
                    }
                    
                    localStorage.setItem('initialQuery', input);
                    
                    showChatInterface();
                    
                    // Reset button state
                    setTimeout(() => {
                        document.getElementById('start-button').disabled = false;
                        document.getElementById('start-button').textContent = 'Begin Task';
                        document.getElementById('welcome-input').value = '';
                    }, 1000);
                }
            });
            
            document.getElementById('welcome-input').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    document.getElementById('start-button').click();
                }
            });
            

            
            document.getElementById('new-task-button').addEventListener('click', function() {
                localStorage.removeItem('initialQuery');
                localStorage.setItem('currentChatId', 'new');
                
                // Auto-close file upload sidebar when creating new task
                if (window.closeFileUploadSidebar) {
                    window.closeFileUploadSidebar();
                }
                
                showWelcomeScreen();
                loadWelcomePageChats();
                // Auto-focus the input for immediate task creation
                setTimeout(() => {
                    document.getElementById('welcome-input').focus();
                }, 100);
            });
            
            fetch('/api/validate-token', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            }).catch(error => {
                console.error('Token validation error:', error);
            });
        });

        // File Upload Functionality
        function initializeFileUpload() {
            const uploadToggleBtn = document.getElementById('upload-toggle-btn');
            const fileUploadSection = document.getElementById('file-upload-section');
            const uploadedFilesSection = document.getElementById('uploaded-files-section');
            const dropzone = document.getElementById('file-dropzone');
            const fileInput = document.getElementById('file-input');
            const uploadButton = document.getElementById('upload-button');
            const progressContainer = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const uploadResults = document.getElementById('upload-results');

            // Toggle file upload section
            uploadToggleBtn.addEventListener('click', () => {
                const isVisible = fileUploadSection.style.display !== 'none';
                fileUploadSection.style.display = isVisible ? 'none' : 'block';
                uploadedFilesSection.style.display = isVisible ? 'none' : 'block';
                
                if (!isVisible) {
                    loadUploadedFiles();
                }
            });

            // Drag and drop handlers
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('drag-over');
            });

            dropzone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                if (!dropzone.contains(e.relatedTarget)) {
                    dropzone.classList.remove('drag-over');
                }
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('drag-over');
                const files = Array.from(e.dataTransfer.files);
                handleFileSelection(files);
            });

            // Click to select files
            dropzone.addEventListener('click', () => {
                fileInput.click();
            });

            uploadButton.addEventListener('click', (e) => {
                e.stopPropagation();
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleFileSelection(files);
            });

            function handleFileSelection(files) {
                if (files.length === 0) return;

                // Show progress
                progressContainer.classList.add('show');
                uploadResults.classList.remove('show');

                uploadFiles(files);
            }

            async function uploadFiles(files) {
                const totalFiles = files.length;
                let completedFiles = 0;
                let failedFiles = [];

                updateProgress(0, `Starting upload of ${totalFiles} file(s)...`);

                for (const file of files) {
                    try {
                        updateProgress(
                            (completedFiles / totalFiles) * 100,
                            `Uploading "${file.name}" (${completedFiles + 1}/${totalFiles})...`
                        );
                        
                        await uploadSingleFile(file);
                        completedFiles++;
                        
                        updateProgress(
                            (completedFiles / totalFiles) * 100,
                            `Uploaded ${completedFiles}/${totalFiles} files`
                        );
                        
                    } catch (error) {
                        console.error('Upload failed for file:', file.name, error);
                        failedFiles.push({name: file.name, error: error.message});
                        
                        // Continue with other files instead of stopping
                        completedFiles++; // Count as processed, even if failed
                        updateProgress(
                            (completedFiles / totalFiles) * 100,
                            `Processing ${completedFiles}/${totalFiles} files (${failedFiles.length} failed)`
                        );
                    }
                }

                // Show final results
                if (failedFiles.length === 0) {
                    showUploadResult(`Successfully uploaded all ${totalFiles} file(s)!`, 'success');
                } else if (completedFiles - failedFiles.length > 0) {
                    showUploadResult(
                        `Uploaded ${completedFiles - failedFiles.length}/${totalFiles} files. ${failedFiles.length} failed.`,
                        'partial'
                    );
                } else {
                    showUploadResult(`All uploads failed. Please check your files and try again.`, 'error');
                }
                
                setTimeout(() => {
                    progressContainer.classList.remove('show');
                    loadUploadedFiles(); // Refresh the file list
                    fileInput.value = ''; // Clear the input
                }, 3000);
            }

            async function uploadSingleFile(file) {
                const currentChatId = localStorage.getItem('currentChatId') || 1;
                const chatId = currentChatId === 'new' ? 1 : currentChatId;
                
                const formData = new FormData();
                formData.append('files', file); // Match the server expectation
                formData.append('chatId', chatId); // Include chatId

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || 'Upload failed');
                }

                return await response.json();
            }

            function updateProgress(percentage, text) {
                progressBar.style.width = `${percentage}%`;
                progressText.textContent = text;
            }

            function showUploadResult(message, type) {
                const uploadMessage = document.getElementById('upload-message');
                uploadMessage.textContent = message;
                uploadResults.className = `upload-results show ${type}`;
            }
        }

        // File Management Functionality
        async function loadUploadedFiles() {
            try {
                // Get current chat ID to filter files
                const currentChatId = localStorage.getItem('currentChatId') || 1;
                const chatId = currentChatId === 'new' ? 1 : currentChatId;
                
                const response = await fetch(`/api/uploads?chatId=${chatId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load files');
                }

                const files = await response.json();
                displayUploadedFiles(files);
            } catch (error) {
                console.error('Error loading files:', error);
                displayUploadedFiles([]);
            }
        }

        function displayUploadedFiles(files) {
            const filesList = document.getElementById('uploaded-files-list');

            if (files.length === 0) {
                filesList.innerHTML = `
                    <div class="uploaded-files-list empty">
                        <i class="fas fa-folder-open"></i>
                        <p>No files uploaded yet</p>
                    </div>
                `;
                return;
            }

            filesList.innerHTML = files.map(file => `
                <div class="file-item" data-file-id="${file.id}">
                    <div class="file-item-icon">
                        <i class="fas ${getFileIcon(file.filename)}"></i>
                    </div>
                    <div class="file-item-info">
                        <div class="file-item-name">${escapeHtml(file.filename)}</div>
                        <div class="file-item-details">
                            <div class="file-item-size">
                                <i class="fas fa-hdd"></i>
                                ${formatFileSize(file.size)}
                            </div>
                            <div class="file-item-date">
                                <i class="fas fa-calendar"></i>
                                ${formatDate(file.upload_date)}
                            </div>
                        </div>
                    </div>
                    <div class="file-item-actions">
                        <button class="file-action-btn" onclick="viewFile('${file.id}', '${escapeHtml(file.filename)}')">
                            <i class="fas fa-eye"></i>
                            View
                        </button>
                        <a class="file-action-btn" href="/api/files/${file.id}/download" download="${escapeHtml(file.filename)}">
                            <i class="fas fa-download"></i>
                            Download
                        </a>
                        <button class="file-action-btn delete" onclick="deleteFile('${file.id}', '${escapeHtml(file.filename)}')">
                            <i class="fas fa-trash"></i>
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'pdf': 'fa-file-pdf',
                'doc': 'fa-file-word',
                'docx': 'fa-file-word',
                'xls': 'fa-file-excel',
                'xlsx': 'fa-file-excel',
                'ppt': 'fa-file-powerpoint',
                'pptx': 'fa-file-powerpoint',
                'txt': 'fa-file-alt',
                'md': 'fa-file-alt',
                'jpg': 'fa-file-image',
                'jpeg': 'fa-file-image',
                'png': 'fa-file-image',
                'gif': 'fa-file-image',
                'svg': 'fa-file-image',
                'mp4': 'fa-file-video',
                'avi': 'fa-file-video',
                'mov': 'fa-file-video',
                'mp3': 'fa-file-audio',
                'wav': 'fa-file-audio',
                'zip': 'fa-file-archive',
                'rar': 'fa-file-archive',
                'tar': 'fa-file-archive',
                'js': 'fa-file-code',
                'html': 'fa-file-code',
                'css': 'fa-file-code',
                'py': 'fa-file-code',
                'java': 'fa-file-code',
                'cpp': 'fa-file-code'
            };
            return iconMap[ext] || 'fa-file';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function viewFile(fileId, filename) {
            try {
                // First get file metadata
                const response = await fetch(`/api/files/${fileId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load file details');
                }

                const fileData = await response.json();
                
                // Try to get content via download endpoint
                const downloadResponse = await fetch(`/api/files/${fileId}/download`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (downloadResponse.ok) {
                    const content = await downloadResponse.text();
                    showFileModal(filename, content);
                } else {
                    throw new Error('File content not available for viewing');
                }
            } catch (error) {
                console.error('Error viewing file:', error);
                alert('Failed to view file: ' + error.message);
            }
        }

        function showFileModal(filename, content) {
            const modal = document.createElement('div');
            modal.className = 'file-content-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${escapeHtml(filename)}</h3>
                        <button class="close-button" onclick="this.closest('.file-content-modal').remove()">
                            &times;
                        </button>
                    </div>
                    <div class="modal-body">
                        <pre>${escapeHtml(content)}</pre>
                    </div>
                </div>
            `;

            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);
        }

        async function deleteFile(fileId, filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/uploads/${fileId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to delete file');
                }

                // Refresh the file list
                loadUploadedFiles();
            } catch (error) {
                console.error('Error deleting file:', error);
                alert('Failed to delete file: ' + error.message);
            }
        }

        // Initialize file upload when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeFileUpload();
            initializeInlineUploadButtons();
        });

        // Initialize inline upload buttons (chat input only)
        function initializeInlineUploadButtons() {
            const chatUploadBtn = document.getElementById('chat-upload-button');
            const chatFileInput = document.getElementById('chat-file-input');

            // Chat input upload button
            if (chatUploadBtn && chatFileInput) {
                chatUploadBtn.addEventListener('click', () => {
                    chatFileInput.click();
                });

                chatFileInput.addEventListener('change', async (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length > 0) {
                        await handleInlineFileUpload(files, 'chat');
                        chatFileInput.value = ''; // Clear the input
                    }
                });
            }
        }

        // Handle file upload from chat input button
        async function handleInlineFileUpload(files, source) {
            let currentChatId = localStorage.getItem('currentChatId') || 'new';
            
            // Show visual feedback
            showInlineUploadFeedback(source, 'uploading', `Uploading ${files.length} file(s)...`);
            
            try {
                const chatId = currentChatId === 'new' ? 1 : currentChatId;
                console.log('Uploading files to chat:', chatId);
                
                showInlineUploadFeedback(source, 'uploading', `Uploading files to chat...`);
                
                let successCount = 0;
                let errorMessages = [];
                
                for (const file of files) {
                    try {
                        const formData = new FormData();
                        formData.append('files', file);
                        formData.append('chatId', chatId);
                        
                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                            },
                            body: formData
                        });

                        if (response.ok) {
                            successCount++;
                            console.log(`Successfully uploaded: ${file.name}`);
                        } else {
                            const errorText = await response.text();
                            errorMessages.push(`${file.name}: ${errorText}`);
                            console.error(`Failed to upload ${file.name}:`, errorText);
                        }
                    } catch (fileError) {
                        errorMessages.push(`${file.name}: ${fileError.message}`);
                        console.error(`Upload error for ${file.name}:`, fileError);
                    }
                }
                
                if (successCount === files.length) {
                    showInlineUploadFeedback(source, 'success', `Successfully uploaded ${successCount} file(s)`);
                    
                    // Refresh the file list in the upload section
                    if (typeof loadUploadedFiles === 'function') {
                        loadUploadedFiles();
                    }
                } else if (successCount > 0) {
                    showInlineUploadFeedback(source, 'partial', `Uploaded ${successCount}/${files.length} files`);
                } else {
                    showInlineUploadFeedback(source, 'error', `Upload failed: ${errorMessages[0] || 'Unknown error'}`);
                }
                
            } catch (error) {
                console.error('Error in file upload process:', error);
                showInlineUploadFeedback(source, 'error', `Upload failed: ${error.message}`);
            }
        }

        // Show visual feedback for inline uploads
        function showInlineUploadFeedback(source, type, message) {
            const button = source === 'welcome'
                ? document.getElementById('welcome-upload-button')
                : document.getElementById('chat-upload-button');
            
            if (!button) return;
            
            // Store original state if not already stored
            if (!button.dataset.originalIcon) {
                button.dataset.originalIcon = button.querySelector('i').className;
                button.dataset.originalColor = button.style.color || '';
                button.dataset.originalTitle = button.title || 'Upload Files';
            }
            
            const icon = button.querySelector('i');
            
            // Clear any existing timeout
            if (button.feedbackTimeout) {
                clearTimeout(button.feedbackTimeout);
            }
            
            // Update button appearance based on type
            if (type === 'uploading') {
                icon.className = 'fas fa-spinner fa-spin';
                button.style.color = 'var(--primary)';
                button.title = message;
                button.disabled = true;
            } else if (type === 'success') {
                icon.className = 'fas fa-check';
                button.style.color = 'var(--success)';
                button.title = message;
                button.disabled = false;
            } else if (type === 'error') {
                icon.className = 'fas fa-exclamation-triangle';
                button.style.color = 'var(--error)';
                button.title = message;
                button.disabled = false;
            }
            
            // Auto-reset after appropriate time (longer for uploads, shorter for status)
            const resetTime = type === 'uploading' ? 30000 : 3000; // 30s for uploads, 3s for status
            
            button.feedbackTimeout = setTimeout(() => {
                icon.className = button.dataset.originalIcon;
                button.style.color = button.dataset.originalColor;
                button.title = button.dataset.originalTitle;
                button.disabled = false;
                button.feedbackTimeout = null;
            }, resetTime);
        }
        
        // Force reset upload feedback (useful for error recovery)
        function resetUploadFeedback(source) {
            const button = source === 'welcome'
                ? document.getElementById('welcome-upload-button')
                : document.getElementById('chat-upload-button');
                
            if (!button) return;
            
            if (button.feedbackTimeout) {
                clearTimeout(button.feedbackTimeout);
                button.feedbackTimeout = null;
            }
            
            if (button.dataset.originalIcon) {
                const icon = button.querySelector('i');
                icon.className = button.dataset.originalIcon;
                button.style.color = button.dataset.originalColor;
                button.title = button.dataset.originalTitle;
                button.disabled = false;
            }
        }
    </script>
    
    <!-- File Modal -->
    <div id="file-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">File Preview</h2>
                <span class="modal-close">&times;</span>
            </div>
            <div id="modal-body" class="modal-body">
                <!-- Content will be inserted here dynamically -->
            </div>
        </div>
    </div>
</body>
</html> 